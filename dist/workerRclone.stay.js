var e,isEmptyStr=function(e){return""===e},isEmptyObj=function(e){if(e===undefined)return!1;if(null===e)return!0;for(var t in e)return!1;return!0},isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},isZero=function(e){return null!=e&&("0"===e||0===e)},t={fg:{black:"30",red:"31",green:"32",yellow:"33",blue:"34",magenta:"35",cyan:"36",white:"37",def:"39"},bg:{black:"40",red:"41",green:"42",yellow:"43",blue:"44",magenta:"45",cyan:"46",white:"47",def:"49"}},getEscSeq=function(e){return e?"\\x1b[":"["},colorlize=function(e){var n=e.message,r=e.esc,i=void 0!==r&&r,a=e.fg,o=e.bg;if(isEmptyStr(n))return"";var c=getEscSeq(i);return!a||isEmptyStr(a)?""+n:""+(""+c+(o?t.bg[o]+";":"")+t.fg[a]+"m")+n+c+"49;39m"},cursorMove=function(e,t,n){void 0===e&&(e="u"),void 0===n&&(n=!1);var r={u:"A",d:"B",l:"C",r:"D"}[e];if(!r)throw new Error('The direction value is incorrect. Valid value is "u", "d", "l", "r"');return""+getEscSeq(n)+t+r},validArgs=function(){for(var e=[],t=PPx.Arguments;!t.atEnd();t.moveNext())e.push(t.value);return e},n={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},r={actions:"S_ppm#actions",event:"S_ppm#event",global:"S_ppm#global",sources:"S_ppm#sources",staymode:"S_ppm#staymode",user:"S_ppm#user"},useLanguage=function(){var e=PPx.Extract("%*getcust("+r.global+":lang)");return"en"===e||"ja"===e?e:n.language},i={storeData:8e4,veHandler:80001,setsel:80002,stackPPb:80003},a=PPx.CreateObject("Scripting.FileSystemObject");String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/,"")}),Array.prototype.removeEmpty||(Array.prototype.removeEmpty=function(){for(var e=[],t=0,n=this.length;t<n;t++){var r=this[t];null==r||""===r||r instanceof Array&&0===r.length||r instanceof Object&&isEmptyObj(r)||e.push(r)}return e}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var r=Object(this),i=r.length>>>0;if(0===i)return-1;var a=null!=t?t:0;if(Math.abs(a)===Infinity&&(a=0),a>=i)return-1;for(n=Math.max(a>=0?a:i-Math.abs(a),0);n<i;){if(n in r&&r[n]===e)return n;n++}return-1});var o,c=(o=PPx.Extract("%*getcust(S_ppm#global:git)"),isEmptyStr(o)?"echo":'"'+o+'\\usr\\bin\\echo.exe"'),winpos=function(e,t,n){return isInteger(t)&&isInteger(n)?"*windowposition "+e+","+(t<0?0:t)+","+(n<0?0:n):""},winsize=function(e,t,n){return isInteger(t)&&isInteger(n)?"*windowsize "+e+","+(t<200?200:t)+","+(n<200?200:n):""},_runCmdline=function(e){var t=e.startwith,n=void 0===t?"":t,r=e.wait,i=void 0===r?"":r,a=e.startmsg,o=void 0===a||a,c=e.priority,p=e.breakjob,u=e.newgroup,s=e.log,d=e.wd,l=e.x,x=e.y,P=e.width,f=e.height,m={"":"",min:"-min",max:"-max",noactive:"-noactive",bottom:"-noactive"}[n],g={"":"",wait:"-wait",idle:"-wait:idle",later:"-wait:later",no:"-wait:no"}[i],b="";if(d){if(!PPx.CreateObject("Scripting.FileSystemObject").FolderExists(d))return[!1,["[WARN] Specified working directory is not exist"]];b="-d:"+d}var v=o?"":"-nostartmsg",E=c?"-"+c:"",h=p?"-breakjob":"",w=u?"-newgroup":"",y=s?"-log":"",S=PPx.Extract("%*getcust(S_ppm#global:disp_width)"),k=PPx.Extract("%*getcust(S_ppm#global:disp_height)");return l&&l>Number(S)&&(l=0),x&&x>Number(k)&&(x=0),[!0,["*run","-noppb",m,g,v,E,h,w,y,b,l&&x?"-pos:"+l+","+x:"",P&&f?"-size:"+P+","+f:""]]},_ppbCmdline=function(e){var t=e.bootid,n=e.bootmax,r=e.q,i=e.c,a=e.k;return{id:t?"-bootid:"+t:"",max:n?"-bootmax:"+n:"",quiet:r?"-q":"",postcmd:i||(a||"")}},runPPb=function(e){var t=e.bootid,n=e.bootmax,r=e.q,i=e.c,a=e.k,o=e.startwith,p=void 0===o?"":o,u=e.wait,s=void 0===u?"":u,d=e.priority,l=e.breakjob,x=e.newgroup,P=e.log,f=e.wd,m=e.x,g=e.y,b=e.width,v=e.height,E=e.desc,h=e.fg,w=e.bg;if(-1!==PPx.Extract("%*ppxlist(-B)").indexOf("B_"+t))return PPx.Execute("*focus B"+t),!0;var y=_runCmdline({startwith:p,wait:s,priority:d,breakjob:l,newgroup:x,log:P,wd:f}),S=y[0],k=y[1];if(!S)return!1;var _=_ppbCmdline({bootid:t,bootmax:n,q:r,c:i,k:a}),j=[];"min"===p||"max"===p||i||(j.push(winpos("%%n",m,g)),j.push(winsize("%%n",b,v)),"bottom"!==p||i||j.push("*selectppx %n")),E&&!isEmptyStr(E)&&j.push(c+' -e "'+colorlize({esc:!0,message:E,fg:h,bg:w})+'"'),j.push(_.postcmd);var D="";j.length>0&&(D=(i?"-c ":"-k ")+j.removeEmpty().join("%%:"));var F=[].concat(k,["%0ppbw.exe",_.id,_.max,_.quiet]).removeEmpty().join(" "),C=!0;try{/^-k $/.test(D)&&(D=""),PPx.Execute(F+" "+D+"%:*wait 500,2")}catch(N){C=!1}return C},ppx_Discard$1=function(e,t){var n;PPx.StayMode=0,t=null!=(n=t)?n:"","DEBUG"===e&&PPx.linemessage("[DEBUG] discard "+t)},p=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit","K_lied"],_validTable=function(e){return~p.indexOf(e)?e:"KC_main"},_linecust=function(e,t,n){return"*linecust "+e+","+t+":"+n+","},_discard=function(e){return function(t){var n=t.table,r=t.label,i=t.mapkey,a=t.cond,o=void 0===a?"instantly":a,c=t.debug,p=void 0===c?"0":c,u=PPx.StayMode,s=PPx.Extract("%n"),d=PPx.Extract('%*name(C,"%FDV")'),l=_validTable(n),x=_linecust(""+r+s,l,e),P=_linecust(""+r+s,l,"CLOSEEVENT"),f={instantly:"",once:'*if("'+s+'"=="%n")%:',hold:'*if("'+s+'"=="%n")&&("'+d+'"!="%*name(C,"%FDV")")%:'},m=[x,P];i&&(PPx.Execute("*mapkey use,"+i),m.push("*mapkey delete,"+i)),m.push('*js ":'+u+',ppx_Discard",'+p+","+r),PPx.Execute(x+"%(*if %*stayinfo("+u+")%:"+f[o]+m.join("%:")+"%)"),PPx.Execute(P+"%("+f.once+P+"%:"+x+"%)"),PPx.Execute('*launch -breakjob -nostartmsg -wait:no %0pptrayw.exe -c %%K"@LOADCUST"')}},getStaymodeId=function(e){e=~e.indexOf(".")?e.slice(0,e.indexOf(".")):e;var t=Number(PPx.Extract("%*getcust(S_ppm#staymode:"+e+")"));return!isNaN(t)&&t>1e4&&t},u=(_discard("ACTIVEEVENT"),_discard("LOADEVENT"),function(e,t,n,r,i){var a="*linecust "+n+","+_validTable(e),o=a+":"+t+",",c={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[i];PPx.Execute(a+":"+t+","+c+"%%:"+o+"%%:"+r),PPx.Execute('%K"@LOADCUST"')}),s="Drives",d="workerRclone",l="ppm-rclone",x="rc_encrypt",P=getStaymodeId(d)||80110,getRemotePath=function(e){var t=PPx.Extract(e);return t.slice(t.indexOf(s)+s.length+1)},getPassCmd=function(){if(!("1"===PPx.Extract("%*getcust(S_ppm#user:"+x+")")))return[!1,""];var e=isEmptyStr(PPx.Extract("%*getcust(_IDpwd:"+s+")"))?'%k"&s&p"%:':"",t=PPx.Extract(e+"%*pass");return isEmptyStr(t)?[!0,""]:[!1,'--password-command="echo '+t+'"']},f={en:{couldNotGetPass:"Could not get decryption password",inputTitle:"Enter decryption password",error:"Cancelled",changeModTime:"Change modification time",overCatSize:"Canceled due to viewing size limit"},ja:{couldNotGetPass:"複合化パスワードを取得できませんでした",inputTitle:"複合化パスワードの入力",error:"中止しました",changeModTime:"更新時刻の変更",overCatSize:"閲覧サイズ上限により中止しました"}},m=1048576,g="K_ppmRclone",b="ppm_rclone_spin",v="remotes.xlf",E="tmp.xlf",h='%sgu"ppmlib"\\spinner.js',w="-nostartmsg -breakjob -wait:no",cache={base:PPx.Extract("%*base").split(" ")[0],ls2lf:PPx.Extract("%*ls2lf"),lfdir:PPx.Extract("%*lfdir"),ttl:6e4*Number(PPx.Extract("%*ttl")),stackdirection:PPx.Extract("%*stackdirection"),stackwidth:PPx.Extract("%*stackwidth"),ppvid:null!=(e=PPx.Extract("%*ppvid"))?e:"R",ppcid:PPx.Extract("%n"),regenerate:""},y=f[useLanguage()],main=function(){var e;a.FolderExists(cache.lfdir)||PPx.Execute("*makedir "+cache.lfdir);var t=getPassCmd();if(e=t[0],cache.passcmd=t[1],e)return statusMsg(y.couldNotGetPass),clearAuthentication(),"";var n=validArgs(),r=n[0],i=n[1];return cache.startwith=null!=r?r:"bottom",cache.spinner=isEmptyStr(i)?undefined:i,cache.running="setup",PPx.StayMode=P,executeAt(cache.ppcid,"*string i,"+d+"="+P+"%:*mapkey use,"+g),ppx_resume()},ppx_resume=function(){cache.ppbid&&!isEmptyStr(PPx.Extract("%N"+cache.ppbid))||startPPb(),executeAt(cache.ppcid,"*string i,RootPath="+cache.base),cache.wd=PPx.Extract("%*path").slice(s.length+1);var e=-1===cache.wd.indexOf(":"),t=getListFilePath(e);if(!cache.running&&isEmptyStr(cache.regenerate))return t;ppx_StopRunning();var n=generateLs2lfCmd(e);if(a.FileExists(t)){if(isEmptyStr(cache.regenerate)&&withinMinutes(t))return t}else PPx.Extract("%*extract("+cache.ppbid+',"echo ;ListFile>'+t+'%%&")');return asyncRclone(n,t),t},ppx_GetValue=function(e){return cache[e]},ppx_SetValue=function(e,t){cache[e]=t},ppx_RegenScore=function(e){cache.regenerate=isZero(e)?cache.regenerate.slice(0,-1):cache.regenerate+"1"},ppx_StopRunning=function(){showSpinner(!1),PPx.Execute("*signal "+cache.ppbid+",kill"),"ppv"===cache.running&&PPx.Execute("*closeppx V"+cache.ppvid),cache.running=undefined},ppx_Resolve=function(e,t){showSpinner(!1),"0"===e?(PPx.Execute("*launch -noppb -hide -nostartmsg -wait copy /Y "+cache.lfdir+"\\"+cache.ppcid+E+" "+t),PPx.Execute("*jumppath -savelocate"),executeAt(cache.ppbid,"*linemessage "+cursorMove("u",3))):statusMsg(y.error),cache.running=undefined},ppx_ChangeModTime=function(){var e=new Date(PPx.Entry.DateLastModified).toLocaleString(),t=PPx.Extract("%*now").replace(" ","T"),n=PPx.Extract('%*input("'+t+'" -title:"'+y.changeModTime+" [ "+e+' ]" -mode:g)');if(!isEmptyStr(n)){ppx_RegenScore(1);var r=getRemotePath("%FDC"),i="rclone "+cache.passcmd+' touch "'+r+'" --localtime -Ct '+n+"%:%K"+cache.ppcid+'"@F5"';PPx.Execute("*script %sgu'ppmlib'\\stackPPb.stay.js,"+cache.stackwidth+","+cache.stackdirection+",%("+i+"%)")}},ppx_CatFile=function(e){if(isEmptyStr(PPx.getIValue(b))&&isZero(PPx.Extract("%*stayinfo("+i.stackPPb+")")))if(PPx.Entry.Size>(isEmptyStr(e)?m:Number(e)))statusMsg(y.overCatSize);else{showSpinner(!0);var t=getRemotePath("%1%\\%R");PPx.Execute("*launch "+w+" rclone "+cache.passcmd+" cat "+t+"|%0ppvw.exe -bootid:"+cache.ppvid+" -k *execute "+cache.ppcid+",*string i,"+b+"="),cache.running="ppv"}},ppx_Config=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if("encryption"===t[0]){var r,i="";if(!("remove"===(null==t?void 0:t[1]))&&(i=PPx.Extract('%*input(-title:"'+y.inputTitle+'" -mode:e)'),isEmptyStr(i)))return;PPx.Execute("rclone "+cache.passcmd+" config encryption remove%&"),clearAuthentication(),isEmptyStr(i)?(r="0",cache.passcmd=""):(r="1",cache.passcmd='--password-command="echo '+i+'"',PPx.Execute("rclone "+cache.passcmd+" config encryption set")),PPx.Execute("*setcust S_ppm#user:"+x+"="+r)}else{var a="-noppb -nostartmsg -breakjob";PPx.Execute("*launch "+a+" %0ppbw -c @rclone "+cache.passcmd+" config "+t.join(" "))}},ppx_Discard=function(){showSpinner(!1),PPx.StayMode=0,"prog"===cache.running&&ppx_StopRunning(),cache.running=undefined,executeAt(cache.ppcid,"*string i,"+d+"=%:*mapkey delete,"+g),closePPb()},ppx_finally=function(){showSpinner(!1),closePPb()},statusMsg=function(e){return executeAt(cache.ppcid,'*linemessage !"'+e)},executeAt=function(e,t){PPx.Execute("*execute "+e+",%("+t+"%)")},getListFilePath=function(e){var t=e?v:cache.wd.replace(/[:\/]/g,"_")+".xlf";return cache.lfdir+"\\"+t},withinMinutes=function(e){var t=a.GetFile(e).DateLastModified,n=new Date;return 0>Number(n)-Number(t)-cache.ttl},showSpinner=function(e){cache.spinner&&(e?PPx.Execute("%Obdq *ppb -c *script "+h+","+cache.ppcid+","+cache.spinner+","+b):executeAt(cache.ppcid,"*string i,"+b+"="))},startPPb=function(){var e=PPx.Extract("%*script(\"%sgu'ppmlib'\\expandSource.js\",ppm-rclone,version)");runPPb({startwith:cache.startwith,wd:cache.lfdir,x:10,y:10,k:"*execute "+cache.ppcid+',*js ":'+P+',ppx_SetValue",ppbid,%%n',desc:l+"["+cache.ppcid+"] version "+e,fg:"cyan"})},closePPb=function(){PPx.Execute("*closeppx "+cache.ppbid)},clearAuthentication=function(){PPx.Execute("*clearauth%:*deletecust _IDpwd:"+s)},generateLs2lfCmd=function(e){var t=cache.lfdir+"\\"+cache.ppcid+E;return e?cache.ls2lf+' -c "F" '+t+" rclone "+cache.passcmd+" listremotes":cache.ls2lf+' -j "A:Attr,d:IsDir,S:Size,W:ModTime,F:Name" '+t+" rclone "+cache.passcmd+" lsjson "+cache.wd},asyncRclone=function(e,t){var n="*linemessage loading...";cache.running="prog",cache.regenerate="",showSpinner(!0),executeAt(cache.ppbid,n+"%:*launch "+w+" "+e+"%:*execute "+cache.ppcid+',*js ":'+P+',ppx_Resolve",%*exitcode,"'+t+'"')};PPx.result=main();
